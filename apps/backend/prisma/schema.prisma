// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// To generate Prisma Client, run: pnpm --filter backend prisma:generate
// Note: You'll need a database connection to generate the full client

enum AppointmentStatus {
  SCHEDULED
  COMPLETED
  CANCELLED
  NO_SHOW
}

model User {
  id        String   @id @default(uuid())
  email     String   @unique
  name      String
  password  String   // Store hashed password
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  ownedShops Shop[]  @relation("ShopOwner")

  @@map("users")
}

model Shop {
  id               String    @id @default(uuid())
  name             String
  squareLocationId String    @unique
  ownerId          String    // Reference to the shop owner
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt

  // Relations
  owner            User             @relation("ShopOwner", fields: [ownerId], references: [id], onDelete: Restrict)
  barbers          Barber[]
  services         Service[]
  customers        Customer[]
  appointments     Appointment[]
  noShowPolicy     NoShowPolicy?
  pages            Page[]

  @@map("shops")
}

model Barber {
  id                 String    @id @default(uuid())
  shopId             String
  displayName        String
  squareTeamMemberId String?
  active             Boolean   @default(true)
  createdAt          DateTime  @default(now())
  updatedAt          DateTime  @updatedAt

  // Relations
  shop               Shop            @relation(fields: [shopId], references: [id], onDelete: Cascade)
  appointments       Appointment[]

  @@unique([squareTeamMemberId, shopId])
  @@map("barbers")
}

model Service {
  id           String   @id @default(uuid())
  shopId       String
  name         String
  description  String?
  durationMins Int
  priceCents   Int
  squareItemId String   @unique
  active       Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Relations
  shop         Shop            @relation(fields: [shopId], references: [id], onDelete: Cascade)
  appointments Appointment[]

  @@map("services")
}

model Customer {
  id               String    @id @default(uuid())
  shopId           String
  squareCustomerId String?   @unique
  firstName        String
  lastName         String
  phone            String
  email            String?
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt

  // Relations
  shop             Shop            @relation(fields: [shopId], references: [id], onDelete: Cascade)
  appointments     Appointment[]
  cards            CustomerCard[]
  payments         PaymentRecord[]

  @@map("customers")
}

model Appointment {
  id              String            @id @default(uuid())
  shopId          String
  barberId        String
  serviceId       String
  customerId      String
  squareBookingId String?
  startAt         DateTime
  endAt           DateTime
  status          AppointmentStatus @default(SCHEDULED)
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt

  // Relations
  shop            Shop            @relation(fields: [shopId], references: [id], onDelete: Cascade)
  barber          Barber          @relation(fields: [barberId], references: [id], onDelete: Restrict)
  service         Service         @relation(fields: [serviceId], references: [id], onDelete: Restrict)
  customer        Customer        @relation(fields: [customerId], references: [id], onDelete: Restrict)
  noShowCharges   NoShowCharge[]
  payments        PaymentRecord[]

  @@map("appointments")
}

model NoShowPolicy {
  id           String    @id @default(uuid())
  shopId       String    @unique
  feeCents     Int
  graceMinutes Int       @default(15)
  enabled      Boolean   @default(true)
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  // Relations
  shop         Shop      @relation(fields: [shopId], references: [id], onDelete: Cascade)

  @@map("no_show_policies")
}

model NoShowCharge {
  id              String    @id @default(uuid())
  appointmentId   String
  amountCents     Int
  squarePaymentId String?   @unique
  chargedAt       DateTime  @default(now())
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  // Relations
  appointment     Appointment @relation(fields: [appointmentId], references: [id], onDelete: Cascade)

  @@map("no_show_charges")
}

model CustomerCard {
  id           String    @id @default(uuid())
  squareCardId String    @unique
  customerId   String
  brand        String?
  last4        String?
  expMonth     Int?
  expYear      Int?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  // Relations
  customer     Customer  @relation(fields: [customerId], references: [id], onDelete: Cascade)

  @@map("customer_cards")
}

enum PaymentStatus {
  PENDING
  COMPLETED
  FAILED
  REFUNDED
  PARTIALLY_REFUNDED
}

model PaymentRecord {
  id              String        @id @default(uuid())
  squarePaymentId String?       @unique
  amountCents     Int
  customerId      String
  appointmentId   String?
  status          PaymentStatus @default(PENDING)
  failureReason   String?
  refundedCents   Int           @default(0)
  currency        String        @default("USD")
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  // Relations
  customer        Customer      @relation(fields: [customerId], references: [id], onDelete: Restrict)
  appointment     Appointment?  @relation(fields: [appointmentId], references: [id], onDelete: SetNull)

  @@map("payment_records")
}

model Page {
  id        String   @id @default(uuid())
  shopId    String
  slug      String
  title     String
  html      String   @db.Text
  isHome    Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  shop      Shop     @relation(fields: [shopId], references: [id], onDelete: Cascade)

  @@unique([shopId, slug])
  @@map("pages")
}

// CustomerNote: long-form notes added by staff
model CustomerNote {
  id         String   @id @default(uuid())
  shopId     String
  customerId String
  authorId   String   // staff who wrote the note
  content    String
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@index([customerId])
  @@map("customer_notes")
}

// CustomerFlag: short keyword or label displayed in admin UI
model CustomerFlag {
  id         String   @id @default(uuid())
  shopId     String
  customerId String
  flag       String   // e.g. "VIP", "NO_SHOW_RISK", "SENSITIVE_SKIN"
  createdAt  DateTime @default(now())

  @@unique([customerId, flag])
  @@map("customer_flags")
}

// CustomerTag: multiple tags, editable by admin
model CustomerTag {
  id         String   @id @default(uuid())
  shopId     String
  customerId String
  tag        String
  createdAt  DateTime @default(now())

  @@unique([customerId, tag])
  @@map("customer_tags")
}

model BarberWorkingHours {
  id         String   @id @default(uuid())
  shopId     String
  barberId   String   // reference to your existing Barber/TeamMember id (keep as string for now)
  dayOfWeek  Int      // 0 = Sunday, 1 = Monday, ... 6 = Saturday
  startTime  String   // "09:00" 24h format
  endTime    String   // "17:00"
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@index([shopId, barberId, dayOfWeek])
  @@map("barber_working_hours")
}

model BarberTimeOff {
  id         String   @id @default(uuid())
  shopId     String
  barberId   String
  startAt    DateTime   // inclusive
  endAt      DateTime   // exclusive or inclusive â€” document your choice
  reason     String?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@index([shopId, barberId, startAt, endAt])
  @@map("barber_time_off")
}