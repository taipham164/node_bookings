<% include("../functions") %>
<!DOCTYPE html>
<html>

<head>
  <link href="/stylesheets/style.css" rel="stylesheet" type="text/css">
  <style>
    .card__wrapper {
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.07);
      margin-bottom: 1.2em;
      padding: 18px 18px 18px 12px;
      display: flex;
      align-items: center;
      transition: box-shadow 0.2s, transform 0.2s;
      border: 1px solid #f0f0f0;
    }
    .card__wrapper:hover {
      box-shadow: 0 4px 16px rgba(0,112,243,0.13);
      transform: translateY(-2px) scale(1.01);
      border: 1px solid #0070f3;
    }
    .service-label {
      display: flex;
      align-items: center;
      width: 100%;
      cursor: pointer;
    }
    .card__image img {
      width: 80px;
      height: 80px;
      object-fit: cover;
      border-radius: 10px;
      margin-right: 18px;
      border: 2px solid #f0f0f0;
      box-shadow: 0 1px 4px rgba(0,0,0,0.04);
      opacity: 0;
      animation: fadeinimg 0.5s forwards;
    }
    @keyframes fadeinimg {
      to { opacity: 1; }
    }
  </style>
</head>

<body>
  <header>
    <%- include("../partials/header") %>
  </header>
  <div class="content">
    <div class="content-left business">
      <div class="business__logo">
        <%if (location.logoUrl) { %>
          <img src="<%= location.logoUrl %>">
        <% } else { %>
          <img src="/images/blank-logo.svg">
        <% } %>
      </div>
      <h3>
        <%= location.businessName || location.name %>
      </h3>
      <%if (location.description) { %>
        <h5> <%= location.description %> </h5>
      <% } %>
      <div class="business__location">
        <h4>Location</h4>
        <div>
          <%if (location.address) { %>
            <%if (location.address.addressLine1) { %>
              <span><%= location.address.addressLine1 %>, </span> <br>
            <% } %>
            <%if (location.address.addressLine2) { %>
              <span><%= location.address.addressLine2 %>, </span>
            <% } %>
            <span>
              <%= location.address.locality %>,
              <%= location.address.administrativeDistrictLevel1 %>,
              <%= location.address.postalCode %>
            </span>
          <% } else { %>
            <span>No location information</span>
          <% } %>
        </div>
      </div>
      <div class="business__contact">
      <h4>Contact</h4>
      <%if (location.phoneNumber || location.businessEmail) { %>
        <%if (location.businessEmail) { %>
          Email: <span> <%= location.businessEmail %> </span>
          <br>
        <% } %>
        <%if (location.phoneNumber) { %>
          Phone:
          <span> <%= location.phoneNumber %> </span>
        <% } %>
      <% } else { %>
          <span>No contact information</span>
      <% } %>
      </div>
      <%if (cancel === "success") { %>
        <div class="success-toast">
          <div>
            <img src="/images/success.svg">Your booking was cancelled successfully!
          </div>
        </div>
      <% } %>
    </div>
    <div class="content-main services">
      <h4> Book an appointment </h4>
      <h4 class="title">Services</h4>
      <h4 class="underline"></h4>
      <% /* Use categorized from backend, do not regroup here! */ %>
      <div class="category-tabs" style="display: flex; gap: 1em; margin-bottom: 1.5em; border-bottom: 1px solid #eee;">
        <% allCategories.forEach(function(cat, idx) { %>
          <button type="button" class="category-tab" data-category="<%= cat.id %>" aria-selected="<%= idx === 0 ? 'true' : 'false' %>" style="background:#f8f8f8;border:2px solid #0070f3;border-bottom:3px solid <%= idx === 0 ? '#0070f3' : 'transparent' %>;padding:10px 18px;font-size:1em;cursor:pointer;font-weight:<%= idx === 0 ? 'bold' : 'normal' %>;color:<%= idx === 0 ? '#0070f3' : '#222' %>;border-radius:6px 6px 0 0;margin-bottom:-2px;min-width:100px;"> <%= cat.name %> </button>
        <% }); %>
      </div>
      <form action="/services/select" method="POST">
        <div class="cards">
          <% allCategories.forEach(function(cat, idx) { %>
            <div class="service-category" data-category-panel="<%= cat.id %>" style="display:<%= idx === 0 ? 'block' : 'none' %>;">
              <% if (categorized[cat.id] && categorized[cat.id].length > 0) { %>
                <% categorized[cat.id].forEach(function(item) { %>
                  <% item.itemData.variations.forEach(function(variation) { %>
                    <% var hasPrice = variation.itemVariationData.priceMoney; %>
                    <div class="card__wrapper<%= hasPrice ? '' : ' card__wrapper--disabled' %>">
                      <label class="service-label<%= hasPrice ? '' : ' service-label--disabled' %>" style="width:100%;align-items:flex-start;gap:18px;">
                        <div class="card__image">
                          <% let imgUrl = null;
                             if (item.itemData.imageIds && item.itemData.imageIds.length > 0) {
                               imgUrl = imageMap[item.itemData.imageIds[0]];
                             }
                          %>
                          <img src="<%= imgUrl ? imgUrl : '/images/blank-logo-sm.svg' %>" alt="<%= item.itemData.name %>" loading="lazy">
                        </div>
                        <div class="card__info" style="flex:1;display:flex;flex-direction:column;gap:6px;">
                          <div style="display:flex;align-items:center;gap:10px;">
                            <input type="checkbox" name="services[]" value="<%= variation.id %>" style="margin:0 8px 0 0;transform:scale(1.2);" <%= hasPrice ? '' : 'disabled' %>>
                            <h4 style="margin:0;font-size:1.15em;font-weight:600;line-height:1.2;"><%= item.itemData.name %></h4>
                          </div>
                          <div style="display:flex;align-items:center;gap:12px;margin-top:2px;">
                            <%if (variation.itemVariationData.pricingType === "FIXED_PRICING" && variation.itemVariationData.priceMoney) { %>
                              <span style="font-weight:500;color:#0070f3;font-size:1.05em;"><%= formatMoney(variation.itemVariationData.priceMoney.amount, variation.itemVariationData.priceMoney.currency) %></span>
                              <span style="color:#888;font-size:0.98em;">• <%= formatTime(variation.itemVariationData.serviceDuration) %></span>
                            <% } else { %>
                              <span style="color:#d00;font-weight:bold;">Call/Text for Estimate</span>
                            <% } %>
                          </div>
                          <div style="margin-top:2px;">
                            <% 
                              // Gather secondary image URLs for this item
                              var secondaryImageUrls = [];
                              if (itemSecondaryImages && itemSecondaryImages[item.id] && itemSecondaryImages[item.id].length > 0) {
                                itemSecondaryImages[item.id].forEach(function(imgId) {
                                  if (imageMap[imgId]) secondaryImageUrls.push(imageMap[imgId]);
                                });
                              }
                            %>
                            <a href="#" class="see-detail-link" data-service='<%- JSON.stringify({
                              name: item.itemData.name,
                              description: item.itemData.description || "No description available.",
                              id: variation.id,
                              price: variation.itemVariationData.priceMoney ? formatMoney(variation.itemVariationData.priceMoney.amount, variation.itemVariationData.priceMoney.currency) : null,
                              secondaryImages: secondaryImageUrls
                            }) %>' style="font-size:0.98em; color:#0070f3; text-decoration:underline;">See detail</a>
                          </div>
                          <div class="quantity-control" style="margin-top:8px;" <%= hasPrice ? '' : 'style=\"pointer-events:none;opacity:0.5;\"' %>>
                            <button type="button" class="qty-btn" onclick="changeQty('<%= variation.id %>', -1)" <%= hasPrice ? '' : 'disabled' %>>-</button>
                            <span id="qty-display-<%= variation.id %>">1</span>
                            <button type="button" class="qty-btn" onclick="changeQty('<%= variation.id %>', 1)" <%= hasPrice ? '' : 'disabled' %>>+</button>
                            <input type="hidden" name="quantities[<%= variation.id %>]" value="1" id="quantity-<%= variation.id %>" autocomplete="off">
                          </div>
                        </div>
                      </label>
                    </div>
                  <% }); %>
                <% }); %>
              <% } else { %>
                <div class="card__wrapper disabled" style="justify-content:center;text-align:center;padding:2em 0;">No services in this category.</div>
              <% } %>
            </div>
          <% }); %>
        </div>
        <button class="button btn-primary continue-fixed-btn" id="continue-btn" type="submit" disabled>
          <span class="continue-btn-label">Continue</span>
        </button>
  <style>
    .continue-fixed-btn {
      transition: background 0.18s, box-shadow 0.18s, transform 0.13s;
    }
    .continue-fixed-btn:not(:disabled):hover {
      background: #005fe6 !important;
      box-shadow: 0 4px 24px rgba(0,106,255,0.18);
      opacity: 1 !important;
      transition: background 0.18s, box-shadow 0.18s, opacity 0.13s;
    }
    .continue-fixed-btn:not(:disabled):active {
      background: #003e99 !important;
      box-shadow: 0 2px 8px rgba(0,106,255,0.10);
      opacity: 0.93 !important;
      transition: background 0.13s, box-shadow 0.13s, opacity 0.13s;
    }
    .continue-btn-label {
      font-weight: 600;
      letter-spacing: 0.01em;
      font-size: 1.1em;
      display: inline-block;
      padding: 0 8px;
    }
  </style>
      </form>
    </div>
  </div>
  <% if (!items.length) {%>
    <div class="developer-note">
      <div>
        <h5>Developer note</h5>
        <span>Looks like you don’t have any services setup yet. Run the seeding script or use the 
          <a href="https://developer.squareup.com/explorer/square/catalog-api/upsert-catalog-object" target="_blank">API Explorer</a> or the Seller Dashboard for your environment
          to create your first service. For more information, check our README file.
        </span>
      </div>
    </div>
  <% } %>
  <% if (typeof error !== 'undefined' && error) { %>
    <div id="popup-error" class="popup-error-overlay">
      <div class="popup-error-dialog">
        <span class="popup-error-close" onclick="document.getElementById('popup-error').style.display='none'">&times;</span>
        <h5>Notice</h5>
        <span><%= error %></span>
      </div>
    </div>
  <% } %>
  <div id="service-detail-modal" class="service-detail-modal" style="display:none;">
    <div class="service-detail-dialog">
      <span class="service-detail-close" onclick="closeServiceDetail()">&times;</span>
      <h3 id="modal-service-name"></h3>
      <div id="modal-service-description"></div>
      <div id="modal-service-price" style="margin: 10px 0;"></div>
      <div id="modal-service-secondary-images" style="display:flex;gap:10px;flex-wrap:wrap;margin:10px 0 18px 0;"></div>
      <div style="margin-top: 20px;">
        <button class="button btn-primary" id="modal-add-service-btn">Add Service</button>
      </div>
    </div>
  </div>
  <div id="service-error" class="service-error-message" style="display:none;">Please select at least one service to continue.</div>
  <script>

  // Category tab switching logic
  document.addEventListener('DOMContentLoaded', function() {
    var tabs = document.querySelectorAll('.category-tab');
    var panels = document.querySelectorAll('.service-category[data-category-panel]');
    tabs.forEach(function(tab) {
      tab.addEventListener('click', function() {
        var selected = this.getAttribute('data-category');
        // Switch tab styles
        tabs.forEach(function(t, i) {
          t.style.borderBottom = '3px solid transparent';
          t.style.fontWeight = 'normal';
          t.style.color = '#222';
          t.setAttribute('aria-selected', 'false');
          t.style.background = '#f8f8f8';
        });
        this.style.borderBottom = '3px solid #0070f3';
        this.style.fontWeight = 'bold';
        this.style.color = '#0070f3';
        this.setAttribute('aria-selected', 'true');
        this.style.background = '#fff';
        // Show/hide panels
        panels.forEach(function(panel) {
          if (panel.getAttribute('data-category-panel') === selected) {
            panel.style.display = 'block';
          } else {
            panel.style.display = 'none';
          }
        });
      });
    });
    // Debug: print allCategories to console
    console.log('Categories:', <%- JSON.stringify(allCategories) %>);
  });

function changeQty(id, delta) {
  var input = document.getElementById('quantity-' + id);
  var display = document.getElementById('qty-display-' + id);
  var checkbox = document.querySelector('input[type="checkbox"][value="' + id + '"]');
  var val = parseInt(input.value, 10) || 1;
  val += delta;
  if (val < 1) val = 1;
  input.value = val;
  display.textContent = val;
  // If user increases quantity, auto-check the box
  if (checkbox && !checkbox.checked && !checkbox.disabled) {
    checkbox.checked = true;
    // Trigger change event so listeners update the continue button
    var event = new Event('change', { bubbles: true });
    checkbox.dispatchEvent(event);
  } else if (checkbox && checkbox.checked && typeof updateContinueBtnState === 'function') {
    // If already checked, still update button state
    updateContinueBtnState();
  }
}

  function closeServiceDetail() {
    document.getElementById('service-detail-modal').style.display = 'none';
  }

  document.addEventListener('DOMContentLoaded', function() {
    document.querySelectorAll('.see-detail-link').forEach(function(link) {
      link.addEventListener('click', function(e) {
        e.preventDefault();
        var data = JSON.parse(this.getAttribute('data-service'));
        document.getElementById('modal-service-name').textContent = data.name;
        document.getElementById('modal-service-description').textContent = data.description;
        document.getElementById('modal-service-price').textContent = data.price ? 'Price: ' + data.price : '';
        // Render secondary images
        var secImgDiv = document.getElementById('modal-service-secondary-images');
        secImgDiv.innerHTML = '';
        if (data.secondaryImages && data.secondaryImages.length > 0) {
          data.secondaryImages.forEach(function(url) {
            var img = document.createElement('img');
            img.src = url;
            img.alt = data.name + ' photo';
            img.style.width = '70px';
            img.style.height = '70px';
            img.style.objectFit = 'cover';
            img.style.borderRadius = '8px';
            img.style.border = '1.5px solid #eee';
            img.style.boxShadow = '0 1px 4px rgba(0,0,0,0.04)';
            img.style.cursor = 'pointer';
            img.addEventListener('click', function(e) {
              e.stopPropagation();
              showBigImage(url, data.name);
            });
            secImgDiv.appendChild(img);
          });
        }
        secImgDiv.style.display = (data.secondaryImages && data.secondaryImages.length > 0) ? 'flex' : 'none';

        // Helper to show a big image overlay
        window.showBigImage = function(url, name) {
          var overlay = document.createElement('div');
          overlay.style.position = 'fixed';
          overlay.style.top = '0';
          overlay.style.left = '0';
          overlay.style.width = '100vw';
          overlay.style.height = '100vh';
          overlay.style.background = 'rgba(0,0,0,0.7)';
          overlay.style.display = 'flex';
          overlay.style.alignItems = 'center';
          overlay.style.justifyContent = 'center';
          overlay.style.zIndex = '9999';
          overlay.addEventListener('click', function() { document.body.removeChild(overlay); });
          var img = document.createElement('img');
          img.src = url;
          img.alt = name + ' large photo';
          img.style.maxWidth = '90vw';
          img.style.maxHeight = '90vh';
          img.style.borderRadius = '12px';
          img.style.boxShadow = '0 4px 32px rgba(0,0,0,0.25)';
          img.style.background = '#fff';
          img.style.display = 'block';
          overlay.appendChild(img);
          document.body.appendChild(overlay);
        };
        document.getElementById('service-detail-modal').style.display = 'flex';
        // Set up add service button
        var addBtn = document.getElementById('modal-add-service-btn');
        addBtn.onclick = function() {
          var checkbox = document.querySelector('input[type="checkbox"][value="' + data.id + '"]');
          if (checkbox && !checkbox.checked && !checkbox.disabled) {
            checkbox.checked = true;
          }
          closeServiceDetail();
        };
      });
    });

    // Prevent submit if no service is selected and update button style
    var form = document.querySelector('form[action="/services/select"]');
    var continueBtn = document.getElementById('continue-btn');
    var errorMsg = document.getElementById('service-error');
    var checkboxes = form.querySelectorAll('input[type="checkbox"][name="services[]"]');
    function updateContinueBtnState() {
      var checked = form.querySelectorAll('input[type="checkbox"][name="services[]"]:checked');
      if (checked.length) {
        continueBtn.disabled = false;
        continueBtn.classList.add('continue-fixed-btn-active');
      } else {
        continueBtn.disabled = true;
        continueBtn.classList.remove('continue-fixed-btn-active');
      }
    }
    checkboxes.forEach(function(cb) {
      cb.addEventListener('change', updateContinueBtnState);
    });
    updateContinueBtnState();
    if (form && continueBtn) {
      form.addEventListener('submit', function(e) {
        var checked = form.querySelectorAll('input[type="checkbox"][name="services[]"]:checked');
        var allCheckboxes = form.querySelectorAll('input[type="checkbox"][name="services[]"]');
        // Enable quantity input for checked, disable for unchecked
        allCheckboxes.forEach(function(cb) {
          var qtyInput = document.getElementById('quantity-' + cb.value);
          if (qtyInput) {
            if (cb.checked) {
              qtyInput.disabled = false;
            } else {
              qtyInput.disabled = true;
            }
          }
        });
        if (!checked.length) {
          e.preventDefault();
          errorMsg.style.display = 'block';
          setTimeout(function() { errorMsg.style.display = 'none'; }, 2500);
          // Optionally scroll to error
          errorMsg.scrollIntoView({behavior: 'smooth', block: 'center'});
        }
      });
    }
  });
  </script>
</body>

</html>