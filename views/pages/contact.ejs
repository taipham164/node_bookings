<% include("../functions") %>
<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Checkout - <%= location?.businessName || 'Booking System' %></title>
    <link href="/stylesheets/style.css" rel="stylesheet" type="text/css">
    <link href="/stylesheets/sidebar.css" rel="stylesheet" type="text/css">
    <link href="/stylesheets/progress-indicator.css" rel="stylesheet" type="text/css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="/javascripts/appointment-summary.js?v=<%= Date.now() %>" defer></script>
    <style>
        .contact-container {
            max-width: none;
            margin: 0;
            padding: 2rem 0;
            padding-bottom: 120px; /* Add space for floating button */
            width: 100%;
            box-sizing: border-box;
            overflow-x: hidden;
        }
        .contact-section {
            background: white;
            border-radius: 15px;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
            width: 100%;
            max-width: 100%;
            box-sizing: border-box;
        }
        .section-header {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 1.5rem;
        }
        .section-header h4 {
            margin: 0;
            color: #333;
            font-size: 1.3rem;
        }
        .section-header i {
            color: #667eea;
            font-size: 1.5rem;
        }
        .form-group {
            margin-bottom: 1.5rem;
        }
        .form-group label {
            display: block;
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: #333;
        }
        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.2s ease;
            box-sizing: border-box;
        }
        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }
        .phone-input-group {
            display: flex;
            align-items: center;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            transition: border-color 0.2s ease;
        }
        .phone-input-group:focus-within {
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        .country-code {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0 12px;
            background: #f8f9fa;
            border-right: 1px solid #e9ecef;
            font-weight: 600;
            color: #333;
        }
        .country-flag {
            width: 20px;
            height: 15px;
            border-radius: 2px;
        }
        .phone-number-input {
            flex: 1;
            border: none;
            padding: 12px 16px;
            font-size: 16px;
            background: transparent;
        }
        .phone-number-input:focus {
            outline: none;
        }
        .helper-text {
            font-size: 0.875rem;
            color: #6c757d;
            margin-top: 0.5rem;
        }
        .submit-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 1rem 2rem;
            border-radius: 8px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
            margin-top: 1rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }
        .submit-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 20px rgba(102, 126, 234, 0.3);
        }
        .submit-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }
        .marketing-consent {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 1rem;
            margin-top: 1rem;
            border: 1px solid #e9ecef;
        }
        .checkbox-group {
            display: flex;
            align-items: flex-start;
            gap: 0.75rem;
            margin-bottom: 0.5rem;
        }
        .checkbox-group input[type="checkbox"] {
            width: auto;
            margin: 0;
            margin-top: 0.25rem;
        }
        .checkbox-group label {
            margin: 0;
            font-weight: 500;
            color: #333;
            line-height: 1.4;
        }
        .consent-details {
            font-size: 0.875rem;
            color: #6c757d;
            line-height: 1.4;
            margin-top: 0.5rem;
        }
        .card-notice {
            color: #6c757d;
            font-size: 0.95rem;
            margin-bottom: 1.5rem;
            line-height: 1.4;
        }
        .card-input-container {
            margin-bottom: 1.5rem;
        }
        .card-input-group {
            display: flex;
            align-items: center;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            padding: 0;
            transition: border-color 0.2s ease;
        }
        .card-input-group:focus-within {
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        .card-icon {
            padding: 12px 16px;
            background: #f8f9fa;
            border-right: 1px solid #e9ecef;
            color: #6c757d;
        }
        .card-input {
            border: none;
            padding: 12px 16px;
            font-size: 16px;
            background: transparent;
            flex: 1;
        }
        .card-input:focus {
            outline: none;
        }
        .card-number {
            flex: 2;
            border-right: 1px solid #e9ecef;
        }
        .card-expiry {
            max-width: 100px;
            border-right: 1px solid #e9ecef;
        }
        .card-cvv {
            max-width: 80px;
        }
        .card-consent {
            margin-top: 1rem;
        }
        .cancellation-timeline {
            display: flex;
            align-items: center;
            margin: 1.5rem 0;
            position: relative;
        }
        .timeline-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            z-index: 2;
        }
        .timeline-marker {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-bottom: 0.5rem;
        }
        .timeline-marker.today {
            background: #28a745;
        }
        .timeline-marker.appointment {
            background: #6c757d;
        }
        .timeline-line {
            flex: 1;
            height: 2px;
            background: #e9ecef;
            margin: 0 1rem;
            position: relative;
            top: -16px;
        }
        .timeline-label {
            font-size: 0.875rem;
            color: #6c757d;
            font-weight: 500;
        }
        .cancellation-notice {
            margin: 1.5rem 0;
            text-align: center;
        }
        .cancel-deadline-btn {
            background: #6c757d;
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin: 0 auto;
        }
        .policy-details {
            color: #333;
            line-height: 1.5;
            margin-bottom: 1.5rem;
        }
        .policy-details p {
            margin-bottom: 0.5rem;
        }
        .policy-consent {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
        }
        .booking-notice {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 1rem;
            color: #6c757d;
            font-size: 0.875rem;
            text-align: center;
            line-height: 1.4;
        }
        .booking-notice p {
            margin: 0;
        }
        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Layout adjustments for the new flex structure */
        .content {
            min-height: calc(100vh - 200px);
        }
        
        /* Desktop layout improvements */
        @media (min-width: 769px) {
            .content-main {
                padding-right: 1rem;
            }
            
            /* Ensure appointment summary is visible and properly sized */
            #appointment-summary {
                flex: 1 1 0;
                min-width: 300px;
                max-width: 400px;
                position: static !important;
                transform: none !important;
                height: fit-content;
                align-self: flex-start;
                position: sticky;
                top: 2rem;
            }
        }
        
        @media (max-width: 768px) {
            .content {
                flex-direction: column !important;
                gap: 0 !important;
            }
            
            .content-main {
                flex: none !important;
                width: 100% !important;
                padding-right: 0 !important;
            }
            
            .contact-container {
                padding: 1rem !important;
                padding-bottom: 120px !important;
            }
            .contact-section {
                padding: 1.5rem;
                margin-bottom: 1.5rem;
            }
            .form-row {
                grid-template-columns: 1fr;
                gap: 0.75rem;
            }
        }
        
        @media (max-width: 480px) {
            .contact-container {
                padding: 0.75rem !important;
                padding-bottom: 120px !important;
            }
            .contact-section {
                padding: 1rem;
                margin-bottom: 1rem;
            }
            .section-header h4 {
                font-size: 1.1rem;
            }
            .section-header i {
                font-size: 1.2rem;
            }
        }
        
        @media (max-width: 360px) {
            .contact-container {
                padding: 0.5rem !important;
                padding-bottom: 120px !important;
            }
            .contact-section {
                padding: 0.75rem;
                border-radius: 10px;
            }
            .section-header {
                gap: 0.5rem;
                margin-bottom: 1rem;
            }
            .section-header h4 {
                font-size: 1rem;
            }
            .section-header i {
                font-size: 1.1rem;
            }
        }
    </style>
</head>

<body>
    <header>
        <%- include("../partials/header") %>
    </header>
    
    <div class="content" style="display: flex; flex-direction: row; gap: 2.5em;">
        <!-- Main contact form -->
        <div class="content-main" style="flex: 2 1 0;">
            <!-- Progress Indicator -->
            <%- include("../partials/progress-indicator", { step: 4 }) %>
            
            <!-- Back Button -->
            <div style="margin-bottom: 2rem;">
                <a class="button" href="/availability/<%= teamMemberBookingProfile.teamMemberId %>/<%= serviceVariation.id %>?version=<%= serviceVersion %>">
                    <span class="icon back-arrow"></span> Back to Date & Time
                </a>
            </div>
            
            <div class="contact-container">
                <!-- Error Message -->
                <% if (typeof error !== 'undefined' && error) { %>
                    <div class="contact-section" style="background: #f8d7da; border-color: #f5c6cb; color: #721c24;">
                        <div class="section-header">
                            <i class="fas fa-exclamation-triangle" style="color: #dc3545;"></i>
                            <h4 style="color: #721c24;">Notice</h4>
                        </div>
                        <p style="margin: 0;"><%= error %></p>
                    </div>
                <% } %>

                <!-- Contact Information Section -->
                <div class="contact-section">
                    <div class="section-header">
                        <i class="fas fa-user-circle"></i>
                        <h4>Contact info</h4>
                    </div>
                    
                    <form id="bookingForm" method="POST" action="/booking/create?serviceId=<%= serviceVariation.id %>&staffId=<%= teamMemberBookingProfile.teamMemberId %>&version=<%= serviceVersion %>&startAt=<%= startAt %>">
                        <!-- Hidden fields for multi-service support -->
                        <% if (selectedServices && selectedServices.length > 1) { %>
                            <% selectedServices.forEach(function(sid) { %>
                                <input type="hidden" name="services[]" value="<%= sid %>">
                                <% if (quantities && quantities[sid]) { %>
                                    <input type="hidden" name="quantities[<%= sid %>]" value="<%= quantities[sid] %>">
                                <% } %>
                            <% }); %>
                        <% } %>
                        
                        <!-- Phone Number Field -->
                        <div class="form-group">
                            <label for="phoneNumber">Phone number</label>
                            <div class="phone-input-group">
                                <div class="country-code">
                                    <img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAiIGhlaWdodD0iMTUiIHZpZXdCb3g9IjAgMCAyMCAxNSIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjIwIiBoZWlnaHQ9IjE1IiBmaWxsPSIjQjIyMjM0Ii8+CjxyZWN0IHdpZHRoPSIyMCIgaGVpZ2h0PSI3LjUiIGZpbGw9IndoaXRlIi8+CjxyZWN0IHdpZHRoPSIyMCIgaGVpZ2h0PSI1IiBmaWxsPSIjM0M0Qjk1Ii8+Cjwvc3ZnPgo=" alt="US Flag" class="country-flag" />
                                    <span>+1</span>
                                </div>
                                <input 
                                    type="tel" 
                                    id="phoneNumber"
                                    name="phoneNumber" 
                                    class="phone-number-input"
                                    required
                                    placeholder="Phone number"
                                    autocomplete="tel"
                                />
                            </div>
                            <div class="helper-text">
                                By providing your phone number you acknowledge you will receive occasional informational messages, including automated messages, on your mobile device from this merchant. Text STOP to opt out at any time, and text HELP to get HELP Message and data rates may apply.
                            </div>
                        </div>

                        <!-- Name Fields -->
                        <div class="form-row">
                            <div class="form-group">
                                <label for="givenName">First name</label>
                                <input 
                                    type="text" 
                                    id="givenName"
                                    name="givenName" 
                                    required 
                                    maxlength="50" 
                                    placeholder="First name"
                                    autocomplete="given-name"
                                />
                            </div>
                            
                            <div class="form-group">
                                <label for="familyName">Last name</label>
                                <input 
                                    type="text" 
                                    id="familyName"
                                    name="familyName" 
                                    required 
                                    maxlength="50" 
                                    placeholder="Last name"
                                    autocomplete="family-name"
                                />
                            </div>
                        </div>

                        <!-- Email Field -->
                        <div class="form-group">
                            <label for="emailAddress">Email</label>
                            <input 
                                type="email" 
                                id="emailAddress"
                                name="emailAddress" 
                                required 
                                maxlength="320" 
                                placeholder="Email"
                                pattern="[a-z0-9._%+-]+@[a-z0-9.-]+\.[a-z]{2,4}$" 
                                title="Please enter a valid email address"
                                autocomplete="email"
                            />
                        </div>

                        <!-- Service Request Field -->
                        <div class="form-group">
                            <label for="serviceNote">
                                <% if (serviceDetails && serviceDetails.length > 0) { %>
                                    <%= serviceDetails[0].name %> Request
                                <% } else { %>
                                    Service Request
                                <% } %>
                            </label>
                            <textarea 
                                id="serviceNote"
                                name="serviceNote" 
                                placeholder="Enter a response"
                                maxlength="1500" 
                                rows="4"
                            ></textarea>
                        </div>

                        <!-- Marketing Consent -->
                        <div class="marketing-consent">
                            <div class="checkbox-group">
                                <input type="checkbox" id="marketingConsent" name="marketingConsent" value="true">
                                <label for="marketingConsent">
                                    Text me marketing and loyalty offers from <%= location?.businessName || 'this business' %>.
                                </label>
                            </div>
                            <div class="consent-details">
                                You consent to receive marketing texts, including Loyalty messages, coupons, and discounts, via the phone number you provided from this business. Text STOP to unsubscribe from texts from this business at any time, or HELP for more information. MSG and data rates may apply. Joining this program is not a condition of purchase. You certify that you are at least 18 years of age.
                            </div>
                        </div>

                        <!-- Submit Button -->
                        <button type="submit" class="submit-btn" id="submitBtn">
                            <i class="fas fa-calendar-check"></i>
                            Book appointment
                        </button>
                    </form>
                </div>

                <!-- Card on File Section -->
                <div class="contact-section">
                    <div class="section-header">
                        <i class="fas fa-credit-card"></i>
                        <h4>Card on file</h4>
                    </div>
                    
                    <p class="card-notice">
                        A credit or debit card is required to book and may be charged in the case of a late cancellation. Protected and encrypted by Square.
                    </p>

                    <div class="card-input-container">
                        <div class="card-input-group">
                            <div class="card-icon">
                                <i class="fas fa-credit-card"></i>
                            </div>
                            <input type="text" placeholder="Card number" class="card-input card-number" />
                            <input type="text" placeholder="MM/YY" class="card-input card-expiry" />
                            <input type="text" placeholder="CVV" class="card-input card-cvv" />
                        </div>
                    </div>

                    <div class="card-consent">
                        <div class="checkbox-group">
                            <input type="checkbox" id="cardConsent" name="cardConsent">
                            <label for="cardConsent">
                                I authorize <%= location?.businessName || "this business" %> to save this card on file for future purchases. 
                                <a href="#" style="color: #667eea; text-decoration: none;">More info</a>
                            </label>
                        </div>
                    </div>
                </div>

                <!-- Cancellation Policy Section -->
                <div class="contact-section">
                    <div class="section-header">
                        <i class="fas fa-calendar-times"></i>
                        <h4>Cancellation policy</h4>
                    </div>

                    <!-- Cancellation Timeline -->
                    <div class="cancellation-timeline">
                        <div class="timeline-item">
                            <div class="timeline-marker today"></div>
                            <div class="timeline-content">
                                <div class="timeline-label">Today</div>
                            </div>
                        </div>
                        <div class="timeline-line"></div>
                        <div class="timeline-item">
                            <div class="timeline-marker appointment"></div>
                            <div class="timeline-content">
                                <div class="timeline-label">Appointment</div>
                            </div>
                        </div>
                    </div>

                    <div class="cancellation-notice">
                        <button type="button" class="cancel-deadline-btn">
                            <i class="fas fa-clock"></i>
                            Cancel before 
                            <% if (typeof startAt !== 'undefined' && startAt && typeof location !== 'undefined' && location) { %>
                                <%= convertDateToText(startAt, location.timezone).split(',')[1].trim() %>
                            <% } else { %>
                                appointment date
                            <% } %>
                        </button>
                    </div>

                    <div class="policy-details">
                        <% if (typeof startAt !== 'undefined' && startAt && typeof location !== 'undefined' && location) { %>
                            <p>Please cancel or reschedule before 8:30 AM on <%= convertDateToText(startAt, location.timezone) %>. After that, you may be charged a cancellation fee of $18.00.</p>
                        <% } else { %>
                            <p>Please cancel or reschedule before the specified time. After that, you may be charged a cancellation fee.</p>
                        <% } %>
                        <a href="#" style="color: #667eea; text-decoration: none; font-weight: 500;">See full policy</a>
                    </div>

                    <div class="policy-consent">
                        <div class="checkbox-group">
                            <input type="checkbox" id="policyConsent" name="policyConsent" required>
                            <label for="policyConsent">
                                I have read and agreed to the cancellation policy of <%= location?.businessName || "this business" %>.
                            </label>
                        </div>
                    </div>

                    <div class="booking-notice">
                        <p>Upon booking, Square will automatically create an account for you with Square Appointments. You can sign back in using your mobile number at any time. You may also receive promotional emails from Square.</p>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Include the appointment summary partial -->
        <%- include("../partials/appointment-summary") %>
    </div>

    <script>
        // Make service details and booking info available to appointment summary JavaScript
        <% if (typeof serviceDetails !== 'undefined' && serviceDetails) { %>
            window.serviceDetails = <%- JSON.stringify(serviceDetails) %>;
        <% } else { %>
            window.serviceDetails = [];
        <% } %>
        
        <% if (typeof teamMemberBookingProfile !== 'undefined' && teamMemberBookingProfile) { %>
            window.selectedStaff = {
                id: "<%= teamMemberBookingProfile.teamMemberId %>",
                name: "<%= teamMemberBookingProfile.displayName %>",
                description: <%- JSON.stringify(teamMemberBookingProfile.description || '') %>
            };
        <% } else { %>
            window.selectedStaff = {
                id: "anyStaffMember",
                name: "Any Available Staff",
                description: ""
            };
        <% } %>

        <% if (typeof startAt !== 'undefined' && startAt && typeof location !== 'undefined' && location) { %>
            window.selectedDateTime = {
                startAt: "<%= startAt %>",
                timezone: "<%= location.timezone %>",
                formattedDate: "<%= convertDateToText(startAt, location.timezone) %>",
                formattedTime: "<%= convertTimeToText(startAt, location.timezone) %>"
            };
        <% } else { %>
            window.selectedDateTime = null;
        <% } %>

        document.addEventListener('DOMContentLoaded', function() {
            // Phone number formatting
            const phoneInput = document.getElementById('phoneNumber');
            const submitBtn = document.getElementById('submitBtn');
            const bookingForm = document.getElementById('bookingForm');
            
            if (phoneInput) {
                let lastValue = '';
                
                phoneInput.addEventListener('input', function(e) {
                    const currentValue = e.target.value;
                    const cursorPos = e.target.selectionStart;
                    const isDeleting = currentValue.length < lastValue.length;
                    
                    // Get just the digits
                    let digits = currentValue.replace(/\D/g, '');
                    
                    // Don't format if user is deleting and would result in same formatted value
                    if (isDeleting && digits.length <= 3) {
                        e.target.value = digits;
                        lastValue = digits;
                        return;
                    }
                    
                    // Format the number
                    let formatted = '';
                    if (digits.length >= 10) {
                        formatted = digits.replace(/(\d{3})(\d{3})(\d{4})/, '($1) $2-$3');
                    } else if (digits.length >= 6) {
                        formatted = digits.replace(/(\d{3})(\d{3})(\d{0,4})/, '($1) $2-$3');
                    } else if (digits.length >= 3) {
                        formatted = digits.replace(/(\d{3})(\d{0,3})/, '($1) $2');
                    } else {
                        formatted = digits;
                    }
                    
                    e.target.value = formatted;
                    lastValue = formatted;
                    
                    // Restore cursor position intelligently
                    let newCursorPos = cursorPos;
                    if (!isDeleting && formatted.length > currentValue.length) {
                        const addedChars = formatted.length - currentValue.length;
                        newCursorPos = cursorPos + addedChars;
                    }
                    e.target.setSelectionRange(newCursorPos, newCursorPos);
                });
                
                // Handle backspace and delete keys specifically
                phoneInput.addEventListener('keydown', function(e) {
                    if (e.key === 'Backspace' || e.key === 'Delete') {
                        const cursorPos = e.target.selectionStart;
                        const currentValue = e.target.value;
                        
                        // If cursor is after a formatting character, skip over it
                        if (e.key === 'Backspace' && cursorPos > 0) {
                            const charBefore = currentValue[cursorPos - 1];
                            if (charBefore === '(' || charBefore === ')' || charBefore === ' ' || charBefore === '-') {
                                e.target.setSelectionRange(cursorPos - 1, cursorPos - 1);
                            }
                        }
                    }
                });
            }

            // Form submission handler
            if (bookingForm) {
                bookingForm.addEventListener('submit', function(e) {
                    const email = document.getElementById('emailAddress');
                    const firstName = document.getElementById('givenName');
                    const lastName = document.getElementById('familyName');
                    const phone = document.getElementById('phoneNumber');
                    
                    // Validate required fields
                    if (!firstName.value.trim() || !lastName.value.trim() || !email.value.trim() || !phone.value.trim()) {
                        e.preventDefault();
                        alert('Please fill in all required fields.');
                        return;
                    }
                    
                    // Phone validation (should be at least 10 digits)
                    const phoneDigits = phone.value.replace(/\D/g, '');
                    if (phoneDigits.length < 10) {
                        e.preventDefault();
                        alert('Please enter a valid 10-digit phone number.');
                        return;
                    }
                    
                    // Email validation
                    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                    if (!emailRegex.test(email.value)) {
                        e.preventDefault();
                        alert('Please enter a valid email address.');
                        return;
                    }
                    
                    // Show loading state
                    if (submitBtn) {
                        submitBtn.disabled = true;
                        submitBtn.innerHTML = '<span class="loading-spinner"></span> Booking appointment...';
                    }
                });
            }

            // Initialize contact page appointment summary
            if (typeof initContactPageSummary === 'function') {
                setTimeout(function() {
                    initContactPageSummary();
                }, 100);
            }

            // Card input formatting
            const cardNumberInput = document.querySelector('.card-number');
            const cardExpiryInput = document.querySelector('.card-expiry');
            const cardCvvInput = document.querySelector('.card-cvv');

            if (cardNumberInput) {
                cardNumberInput.addEventListener('input', function(e) {
                    let value = e.target.value.replace(/\D/g, '');
                    let formattedValue = '';
                    
                    for (let i = 0; i < value.length; i++) {
                        if (i > 0 && i % 4 === 0) {
                            formattedValue += ' ';
                        }
                        formattedValue += value[i];
                    }
                    
                    e.target.value = formattedValue;
                });
            }

            if (cardExpiryInput) {
                cardExpiryInput.addEventListener('input', function(e) {
                    let value = e.target.value.replace(/\D/g, '');
                    if (value.length >= 2) {
                        value = value.substring(0, 2) + '/' + value.substring(2, 4);
                    }
                    e.target.value = value;
                });
            }

            if (cardCvvInput) {
                cardCvvInput.addEventListener('input', function(e) {
                    let value = e.target.value.replace(/\D/g, '');
                    e.target.value = value.substring(0, 4);
                });
            }
        });
    </script>
</body>
</html>
      border-radius: 8px;
      font-size: 1.1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      width: 100%;
      margin-top: 1rem;
    }
    .submit-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 20px rgba(102, 126, 234, 0.3);
    }
    .btn-secondary {
      background: #6c757d;
      color: white;
      border: none;
      padding: 0.75rem 1.5rem;
      border-radius: 8px;
      font-size: 1rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.3s ease;
      margin-left: 1rem;
    }
    .btn-secondary:hover {
      background: #5a6268;
      transform: translateY(-1px);
    }
    .button-group {
      display: flex;
      align-items: center;
      flex-wrap: wrap;
      gap: 1rem;
      margin-top: 1.5rem;
    }
    .customer-info-display {
      background: #e8f5e8;
      border: 1px solid #c3e6c3;
      border-radius: 8px;
      padding: 1.5rem;
      margin: 1rem 0;
    }
    .customer-info-display h6 {
      margin: 0 0 1rem 0;
      color: #155724;
      font-weight: 600;
    }
    .customer-info-display .info-item {
      display: flex;
      align-items: center;
      margin-bottom: 0.5rem;
    }
    .customer-info-display .info-item i {
      width: 20px;
      margin-right: 0.5rem;
      color: #28a745;
    }
    .loading-spinner {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid #f3f3f3;
      border-top: 3px solid #667eea;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    .hidden {
      display: none !important;
    }
    @media (max-width: 768px) {
      .form-row {
        grid-template-columns: 1fr;
      }
      .contact-container {
        padding: 1rem;
      }
    }
  </style>
</head>

<body>
  <header>
    <%- include("../partials/header") %>
  </header>

  <div class="content">
    <div class="content-left">
      <a class="button" href="/availability/<%= teamMemberBookingProfile.teamMemberId %>/<%= serviceVariation.id %>?version=<%= serviceVersion %>">
        <span class="icon back-arrow"></span> Back
      </a>
      <div class="steps">
        <div class="steps__step">
          <div class="steps__step-wrapper">
            <div class="steps__step-title">
              <span>Services</span>
              <a href="/services">Edit</a>
            </div>
            <div class="steps__step-body">
              <% if (serviceDetails && serviceDetails.length > 0) { %>
                <ul>
                  <% serviceDetails.forEach(function(s) { %>
                    <li>
                      <%= s.name %><% if (s.quantity > 1) { %> (x<%= s.quantity %>)<% } %> - <%= formatTime(s.duration) %>
                    </li>
                  <% }); %>
                </ul>
              <% } %>
            </div>
          </div>
        </div>
        <div class="steps__step">
          <div class="steps__step-wrapper">
            <div class="steps__step-title">
              <span>Select staff</span>
              <a href="/staff/<%= serviceVariation.id %>?version=<%= serviceVersion %>">Edit</a>
            </div>
            <div class="availability-staff__card-wrapper">
              <div class="staff__card-picture-wrapper">
                <% if (teamMemberBookingProfile.profileImageUrl) { %>
                  <img src="<%= teamMemberBookingProfile.profileImageUrl %>" />
                <% } else { %>
                  <%= getStaffInitials(teamMemberBookingProfile.displayName) %>
                <% } %>
              </div>
              <div class="steps__staff-step-body">
                <div class="steps__step-name">
                  <%= teamMemberBookingProfile.displayName %>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="steps__step">
          <div class="steps__step-wrapper">
            <div class="steps__step-title">
              <span>Appointment time</span>
              <a href="/availability/<%= teamMemberBookingProfile.teamMemberId %>/<%= serviceVariation.id %>?version=<%= serviceVersion %>">Edit</a>
            </div>
            <div class="steps__step-body">
              <div class="steps__step-name">
                <%= convertDateToText(startAt, location.timezone) %>
              </div>
              <div class="steps__step-description">
                <%= convertTimeToText(startAt, location.timezone) %>
              </div>
            </div>
          </div>
        </div>
        <div class="steps__step selected">
          <div class="steps__step-wrapper">
            <div class="steps__step-title">
              <span>Enter your details</span>
              <span class="icon side-caret-selected"></span>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <div class="content-main">
      <div class="contact-container">
        <% if (typeof error !== 'undefined' && error) { %>
          <div class="popup-error-overlay">
            <div class="popup-error-dialog">
              <span class="popup-error-close" onclick="this.parentElement.parentElement.style.display='none'">&times;</span>
              <h5>Notice</h5>
              <span><%= error %></span>
            </div>
          </div>
        <% } %>
        
        <h4><i class="fas fa-phone me-2"></i>Complete Your Booking</h4>
        <p class="text-muted">Please provide your phone number to continue with your booking.</p>
        
        <!-- Phone Number Verification Step -->
        <div id="phoneStep" class="form-step active">
          <h6><i class="fas fa-mobile-alt me-2"></i>Phone Number Verification</h6>
          <p class="text-muted">Enter your phone number to check if you're an existing customer.</p>
          
          <div class="form-group phone-field">
            <label for="phoneNumber">
              <i class="fas fa-phone me-1"></i>Phone Number *
            </label>
            <input 
              type="tel" 
              id="phoneNumber"
              name="phoneNumber" 
              required
              placeholder="(916) 123-4567"
              autocomplete="tel"
            />
            <div class="helper-text">
              <i class="fas fa-info-circle text-primary"></i>
              We'll check if you're an existing customer to streamline your booking
            </div>
          </div>
          
          <button type="button" id="verifyPhoneBtn" class="submit-btn">
            <i class="fas fa-search me-2"></i>
            Check Phone Number
          </button>
        </div>
        
        <!-- Customer Information Form (Hidden Initially) -->
        <form id="bookingForm" class="contact-form" method="POST" action="/booking/create?serviceId=<%= serviceVariation.id %>&staffId=<%= teamMemberBookingProfile.teamMemberId %>&version=<%= serviceVersion %>&startAt=<%= startAt %>" style="display: none;">
          <!-- Hidden fields for multi-service support -->
          <% if (selectedServices && selectedServices.length > 1) { %>
            <% selectedServices.forEach(function(sid) { %>
              <input type="hidden" name="services[]" value="<%= sid %>">
              <% if (quantities && quantities[sid]) { %>
                <input type="hidden" name="quantities[<%= sid %>]" value="<%= quantities[sid] %>">
              <% } %>
            <% }); %>
          <% } %>
          
          <!-- Hidden phone field to pass verified phone -->
          <input type="hidden" id="verifiedPhone" name="phoneNumber" value="">
          
          <!-- Existing Customer Confirmation (Hidden Initially) -->
          <div id="existingCustomerStep" class="form-step" style="display: none;">
            <h6><i class="fas fa-user-check me-2"></i>Welcome Back!</h6>
            <div id="customerInfo" class="customer-info-display">
              <!-- Customer info will be populated here -->
            </div>
            <p class="text-muted">Is this information correct?</p>
            
            <div class="form-group">
              <label for="existingCustomerNote">
                <i class="fas fa-comment me-1"></i>Appointment Notes (Optional)
              </label>
              <textarea 
                id="existingCustomerNote"
                name="existingCustomerNote" 
                placeholder="Any special requests or notes for your appointment..."
                maxlength="1500" 
                rows="4"
              ></textarea>
            </div>
            
            <div class="button-group">
              <button type="button" id="confirmExistingBtn" class="submit-btn">
                <i class="fas fa-calendar-check me-2"></i>
                Confirm & Book Appointment
              </button>
              <button type="button" id="updateInfoBtn" class="btn btn-secondary">
                <i class="fas fa-edit me-2"></i>
                Update My Information
              </button>
            </div>
          </div>
          
          <!-- New Customer Form (Hidden Initially) -->
          <div id="newCustomerStep" class="form-step" style="display: none;">
            <h6><i class="fas fa-user-plus me-2"></i>New Customer Information</h6>
            <p class="text-muted">Please provide your details to create your customer profile.</p>
            
            <div class="form-row">
              <div class="form-group">
                <label for="givenName">
                  <i class="fas fa-user me-1"></i>First Name *
                </label>
                <input 
                  type="text" 
                  id="givenName"
                  name="givenName" 
                  required 
                  maxlength="50" 
                  placeholder="Enter your first name"
                  autocomplete="given-name"
                />
              </div>
              
              <div class="form-group">
                <label for="familyName">
                  <i class="fas fa-user me-1"></i>Last Name *
                </label>
                <input 
                  type="text" 
                  id="familyName"
                  name="familyName" 
                  required 
                  maxlength="50" 
                  placeholder="Enter your last name"
                  autocomplete="family-name"
                />
              </div>
            </div>
            
            <div class="form-group">
              <label for="emailAddress">
                <i class="fas fa-envelope me-1"></i>Email Address *
              </label>
              <input 
                type="email" 
                id="emailAddress"
                name="emailAddress" 
                required 
                maxlength="320" 
                placeholder="Enter your email address"
                pattern="[a-z0-9._%+-]+@[a-z0-9.-]+\.[a-z]{2,4}$" 
                title="Please enter a valid email address"
                autocomplete="email"
              />
            </div>
            
            <div class="form-group">
              <label for="newCustomerNote">
                <i class="fas fa-comment me-1"></i>Appointment Notes (Optional)
              </label>
              <textarea 
                id="newCustomerNote"
                name="newCustomerNote" 
                placeholder="Any special requests or notes for your appointment..."
                maxlength="1500" 
                rows="4"
              ></textarea>
            </div>
            
            <button type="submit" class="submit-btn">
              <i class="fas fa-calendar-check me-2"></i>
              Create Account & Book Appointment
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', function() {
      // Phone number formatting
      const phoneInput = document.getElementById('phoneNumber');
      const verifyPhoneBtn = document.getElementById('verifyPhoneBtn');
      const phoneStep = document.getElementById('phoneStep');
      const bookingForm = document.getElementById('bookingForm');
      const existingCustomerStep = document.getElementById('existingCustomerStep');
      const newCustomerStep = document.getElementById('newCustomerStep');
      const verifiedPhoneInput = document.getElementById('verifiedPhone');
      
      if (phoneInput) {
        let lastValue = '';
        
        phoneInput.addEventListener('input', function(e) {
          const currentValue = e.target.value;
          const cursorPos = e.target.selectionStart;
          const isDeleting = currentValue.length < lastValue.length;
          
          // Get just the digits
          let digits = currentValue.replace(/\D/g, '');
          
          // Don't format if user is deleting and would result in same formatted value
          if (isDeleting && digits.length <= 3) {
            e.target.value = digits;
            lastValue = digits;
            if (verifyPhoneBtn) {
              verifyPhoneBtn.disabled = true;
            }
            return;
          }
          
          // Format the number
          let formatted = '';
          if (digits.length >= 10) {
            formatted = digits.replace(/(\d{3})(\d{3})(\d{4})/, '($1) $2-$3');
          } else if (digits.length >= 6) {
            formatted = digits.replace(/(\d{3})(\d{3})(\d{0,4})/, '($1) $2-$3');
          } else if (digits.length >= 3) {
            formatted = digits.replace(/(\d{3})(\d{0,3})/, '($1) $2');
          } else {
            formatted = digits;
          }
          
          e.target.value = formatted;
          lastValue = formatted;
          
          // Restore cursor position intelligently
          let newCursorPos = cursorPos;
          if (!isDeleting && formatted.length > currentValue.length) {
            // If we added formatting characters, adjust cursor
            const addedChars = formatted.length - currentValue.length;
            newCursorPos = cursorPos + addedChars;
          }
          e.target.setSelectionRange(newCursorPos, newCursorPos);
          
          // Enable/disable verify button based on phone length
          if (verifyPhoneBtn) {
            verifyPhoneBtn.disabled = digits.length < 10;
          }
        });
        
        // Handle backspace and delete keys specifically
        phoneInput.addEventListener('keydown', function(e) {
          if (e.key === 'Backspace' || e.key === 'Delete') {
            const cursorPos = e.target.selectionStart;
            const currentValue = e.target.value;
            
            // If cursor is after a formatting character, skip over it
            if (e.key === 'Backspace' && cursorPos > 0) {
              const charBefore = currentValue[cursorPos - 1];
              if (charBefore === '(' || charBefore === ')' || charBefore === ' ' || charBefore === '-') {
                e.target.setSelectionRange(cursorPos - 1, cursorPos - 1);
              }
            }
          }
        });
      }
      
      // Phone verification handler
      if (verifyPhoneBtn) {
        verifyPhoneBtn.addEventListener('click', async function() {
          const phone = phoneInput.value.replace(/\D/g, '');
          
          if (phone.length < 10) {
            alert('Please enter a valid 10-digit phone number');
            return;
          }
          
          // Show loading state
          const originalText = verifyPhoneBtn.innerHTML;
          verifyPhoneBtn.innerHTML = '<span class="loading-spinner"></span> Checking...';
          verifyPhoneBtn.disabled = true;
          
          try {
            // Check if customer exists
            const response = await fetch('/customer/check-phone', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
              },
              body: JSON.stringify({ phoneNumber: phoneInput.value })
            });
            
            const result = await response.json();
            
            // Store verified phone number
            verifiedPhoneInput.value = phoneInput.value;
            
            // Hide phone step and show booking form
            phoneStep.style.display = 'none';
            bookingForm.style.display = 'block';
            
            if (result.exists) {
              // Show existing customer flow
              showExistingCustomer(result.customer);
            } else {
              // Show new customer flow
              showNewCustomer();
            }
            
          } catch (error) {
            console.error('Error checking phone:', error);
            alert('Error checking phone number. Please try again.');
            
            // Reset button state on error
            verifyPhoneBtn.innerHTML = originalText;
            verifyPhoneBtn.disabled = phone.replace(/\D/g, '').length < 10;
          }
        });
      }
      
      function showExistingCustomer(customer) {
        existingCustomerStep.style.display = 'block';
        newCustomerStep.style.display = 'none';
        
        // Populate customer info
        const customerInfo = document.getElementById('customerInfo');
        customerInfo.innerHTML = `
          <h6><i class="fas fa-user-check me-2"></i>Customer Information</h6>
          <div class="info-item">
            <i class="fas fa-user"></i>
            <span><strong>Name:</strong> ${customer.givenName || ''} ${customer.familyName || ''}</span>
          </div>
          <div class="info-item">
            <i class="fas fa-envelope"></i>
            <span><strong>Email:</strong> ${customer.emailAddress || 'Not provided'}</span>
          </div>
          <div class="info-item">
            <i class="fas fa-phone"></i>
            <span><strong>Phone:</strong> ${phoneInput.value}</span>
          </div>
        `;
        
        // Store customer info in hidden fields
        addHiddenField('customerId', customer.id);
        addHiddenField('givenName', customer.givenName || '');
        addHiddenField('familyName', customer.familyName || '');
        addHiddenField('emailAddress', customer.emailAddress || '');
      }
      
      function showNewCustomer() {
        existingCustomerStep.style.display = 'none';
        newCustomerStep.style.display = 'block';
      }
      
      function addHiddenField(name, value) {
        // Remove existing field if it exists
        const existing = bookingForm.querySelector(`input[name="${name}"]`);
        if (existing) {
          existing.remove();
        }
        
        // Add new hidden field
        const hiddenField = document.createElement('input');
        hiddenField.type = 'hidden';
        hiddenField.name = name;
        hiddenField.value = value;
        bookingForm.appendChild(hiddenField);
      }
      
      // Confirm existing customer handler
      const confirmExistingBtn = document.getElementById('confirmExistingBtn');
      if (confirmExistingBtn) {
        confirmExistingBtn.addEventListener('click', function() {
          // Submit the form for existing customer
          confirmExistingBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Booking...';
          confirmExistingBtn.disabled = true;
          bookingForm.submit();
        });
      }
      
      // Update info handler
      const updateInfoBtn = document.getElementById('updateInfoBtn');
      if (updateInfoBtn) {
        updateInfoBtn.addEventListener('click', function() {
          // Switch to new customer form to update info
          showNewCustomer();
        });
      }

      // Form submission handler for new customers
      if (bookingForm) {
        bookingForm.addEventListener('submit', function(e) {
          const email = document.getElementById('emailAddress');
          const firstName = document.getElementById('givenName');
          const lastName = document.getElementById('familyName');
          const submitBtn = bookingForm.querySelector('button[type="submit"]');
          
          // Only validate if new customer form is visible
          if (newCustomerStep.style.display !== 'none') {
            if (!firstName.value.trim() || !lastName.value.trim() || !email.value.trim()) {
              e.preventDefault();
              alert('Please fill in all required fields.');
              return;
            }
            
            // Email validation
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(email.value)) {
              e.preventDefault();
              alert('Please enter a valid email address.');
              return;
            }
          }
          
          // Show loading state
          if (submitBtn) {
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Creating Booking...';
          }
        });
      }
    });
  </script>
</body>
</html>